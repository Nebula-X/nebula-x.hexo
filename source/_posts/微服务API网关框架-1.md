---
title: 微服务API网关框架(1)--介绍
catalog: true
date: 2018-12-07 14:27:21
subtitle:
header-img: "Demo.png"
tags:
- 微服务API网关
catagories:
- 微服务API网关
---

# 概念介绍
    
### 网关作用
    统一入口
    安全：黑名单、权限身份认证
    限流：实现微服务访问流量计算，基于流量计算分析进行限流，可以定义多种限流规则。
    缓存：数据缓存
    日志：日志记录
    监控：记录请求响应数据，api耗时分析，性能监控
    重试：异常重试
    熔断：降级 (防止服务雪崩)
    
### API网关
    API网关是一个服务器，是系统的唯一入口。从面向对象设计的角度看，它与外观模式类似。
    API网关封装了系统内部架构，为每个客户端提供一个定制的API。它可能还具有其它职责，
    如身份验证、监控、负载均衡、缓存、请求分片与管理、静态响应处理。
    
    API网关方式的核心要点是，所有的客户端和消费端都通过统一的网关接入微服务，
    在网关层处理所有的非业务功能。通常，网关也是提供REST/HTTP的访问API。
    服务端通过API-GW注册和管理服务。

### API网关种类
1. 单节点网关
![单节点场景网关](单节点场景网关.png)
2.多节点网关
![多节点场景网关](多节点场景网关.png)

#### API网关网关的价值
    网关层对外部和内部进行了隔离，保障了后台服务的安全性。 
    对外访问控制由网络层面转换成了运维层面，减少变更的流程和错误成本 
    减少客户端与服务的耦合，服务可以独立发展。通过网关层来做映射。 
    通过网关层聚合，减少外部访问的频次，提升访问效率。 
    节约后端服务开发成本，减少上线风险。 
    为服务熔断，灰度发布，线上测试提供简单方案。

## 开源微服务项目
    Dubbo
    Spring Cloud
    
## 开源网关项目
    Tyk：Tyk是一个开放源码的API网关，它是快速、可扩展和现代的。Tyk提供了一个API管理平台，其中包括API网关、
         API分析、开发人员门户和API管理面板。Try 是一个基于Go实现的网关服务。
    Kong：Kong是一个可扩展的开放源码API Layer(也称为API网关或API中间件)。Kong 在任何RESTful API的前面运行，通过插件扩展，它提供了超越核心平台的额外功能和服务。
    Orange：和Kong类似也是基于OpenResty的一个API网关程序，是由国人开发的。
    Netflix zuul：Zuul是一种提供动态路由、监视、弹性、安全性等功能的边缘服务。Zuul是Netflix出品的一个基于JVM路由和服务端的负载均衡器。
    apiaxle: Nodejs 实现的一个 API 网关。
    api-umbrella: Ruby 实现的一个 API 网关。

## 网关技术选型
    kong 
        包含功能
        (
            统一入口
            安全：黑名单、权限身份认证
            限流：实现微服务访问流量计算，基于流量计算分析进行限流，可以定义多种限流规则。
            缓存：数据缓存
            日志：日志记录
            监控：记录请求响应数据，api耗时分析，性能监控
        )
    Zuul
        包含功能
        (
            重试
            熔断
        )
        
    kong 是基于Nginx + Lua模式开发出来的，我们将要自己搭建一个属于自己的网关，所以采用Nginx + Lua，真实部署的时候可以
    采用kong+zuul的模式进行实际部署，因为自己搭建的需要考虑的问题有很多，当然自己构建的话，灵活性和个性化设置也是可以控制的，
    这个需要看看团队的实际需要，客观进行评估.
       
### 架构实现图
![架构](架构.png)
![架构2](架构2.png)
![架构3](架构3.png)

### 项目运行环境
    CentOS

### Nginx安装
    1、Nginx下载：nginx-1.13.0.tar.gz，下载到：/opt/softwares/
        $ wget http://nginx.org/download/nginx-1.13.0.tar.gz
    2、Nginx解压安装：
        $ tar -zxvf nginx-1.13.0.tar.gz -C ./
    3、预先安装(nginx所需要的运行库)
        $ yum -y install gcc gcc-c++ ncurses-devel perl pcre pcre-devel zlib gzip zlib-devel
    4、Nginx编译
        $ ./configure --prefix=/usr/local/nginx
    5、安装Nginx：
        安装命令：make & make install
    6、查看安装路径
        $ cd /usr/local/nginx
        $ ll
        
        // 文件夹路径解读
        conf 存放配置文件
        html 网页文件
        logs 存放日志
        sbin   shell启动、停止等脚本
    7、启动nginx
        $ cd sbin
        $ ./nginx
    8、浏览器，访问ip地址，默认80端口
        http://127.0.0.1
    9、停止nginx
        // 查询nginx的状态
        $ ps -ef | grep nginx
        执行命令：$ kill –INT 进程号
        $ kill -INT 3844
    
        $ ./nginx -s stop
    
    10、重新读取配置文件
        $ nginx -s reload
    
    11、检查配置文件是否正确
    $ ./nginx -t
    
    问题报错：[error] invalid PID number "" in "/usr/local/nginx/logs/nginx.pid"
    
    解决方案:
    // 注意: -c 带的文件路径必须是绝对路径，相对路径是不行的
    # /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
        -c的命令是指定配置文件位置

## 代理

### 正向代理
    用户要访问服务器C，但因为网络原因无法访问，但是服务器A可以访问服务器C，这样可以把服务器A设置为正向代理服务器
    由服务器A去请求服务器C，然后服务器A把数据返回给客户
![正向代理](正向代理.png)

### 反向代理
    用户需要访问一些服务器应用，但对方不想把服务器应用地址暴露给用户，这样可以确保安全。那客户如果访问，可以通过反向代理
    服务器，用户只需要知道反向代理服务器地址就可以了，最后反向代理服务器去访问服务器的应用
![反向代理](反向代理.png)    

### 总结: 正向代理与反向代理的区别
    (1)正向代理是需要在用户的电脑上，配置正向服务代理器的；而反向代理则不需要，因为用户是直接访问反向代理器的
    (2)正向代理的应用场景是用户是知道目标服务器地址，如:http://www.baidu.com,但是不能直接的访问，那么就需要在电脑配置一个正向
        代理服务器，用户再次访问的地址就是www.google.com
        而反向代理的应用场景是，用户本来就是不知道目标服务器的地址，而是由平台方提供一个反向代理服务器的地址，
        用户直接访问反向代理服务器的地址就行了，www.a.com
        不管目标服务器有多少，用户是不需要关心的，只要访问反向代理服务器就OK，由反向代理服务器去解析访问目标服务器
    (3)反向代理，极大的保护了应用的安全性，而且此结构能够很好的搭建负载均衡  

